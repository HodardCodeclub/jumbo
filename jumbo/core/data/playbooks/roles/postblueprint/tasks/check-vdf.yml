- name: Get version definitions details
  uri:
    url: "http://{{ hostvars[groups['ambariserver'][0]]['ansible_all_ipv4_addresses'][0] }}:8080/api/v1/version_definitions/{{ item }}"
    headers:
      X-Requested-By: ambari
    method: GET
    force_basic_auth: yes
    user: "{{ ambari.user }}"
    password: "{{ ambari.pwd }}"
    status_code: 200, 201, 202, 404
    body_format: json
    return_content: yes
  register: versions
  with_items: "{{ versions_ids }}"

- name: Format version definitions contents
  vars:
    versions_contents: []
  set_fact:
    versions_contents: "{{ versions_contents }} + [ {{ item }} ]"
  with_items: "{{ versions|json_query('results[*].content') }}"
  no_log: true

- name: Compare VDF files urls
  set_fact:
    existing_url: "{{ existing_url or (vdf_file_url == versions_contents[item - 1].VersionDefinition.version_url) }}"
  with_items: "{{ versions_ids }}"

- debug:
    msg:
      - A version definition with the url '{{ vdf_file_url }}' already exists.
      - Skipping POST to server.
