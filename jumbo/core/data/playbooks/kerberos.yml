---
- hosts: all
  vars:
    ambari:
      ssl:
        enabled: False
        port: 8442
      url: >
        {{ 'https' if ambari.ssl.enabled else 'http' }}://
        {{ hostvars[groups["ambariserver"][0]]["ansible_all_ipv4_addresses"][0] }}:
        {{ ambari.ssl.port if ambari.ssl.enabled else '8080' }}

- hosts: ambariserver
  roles:
    - role: kerberos
      action: "krb_install"
      # vars:
      #   ambari_url: "{{ 'https' if ambari.ssl.enabled else 'http' }}://\
      #                   {{ hostvars[groups['ambariserver'][0]]['ansible_all_ipv4_addresses'][0] }}:\
      #                   {{ ambari.ssl.port if ambari.ssl.enabled else '8080' }}"


- hosts: ipaserver
  become: true
  roles:
    - role: kerberos
      action: "krb_add_users_services"
    - role: kerberos
      action: "krb_ambari_keytab"

- hosts: ambariserver
  become: true
  roles:
    - role: kerberos
      action: "krb_ambari_setup"

- hosts: ipaserver
  become: true
  roles:
    - role: kerberos
      action: "krb_generate_keytabs"

- hosts: all:!ipaserver
  become: true
  roles:
    - role: kerberos
      action: "krb_distribute_keytabs"

- hosts: all
  become: true
  roles:
    - role: kerberos
      action: "krb_set_krb5_conf"

