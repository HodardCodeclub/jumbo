---
- name: Copy ssh_key to ambariserver
  copy:
    src: "/tmp/id_rsa_ambari"
    dest: "{{ ambari_key_dest }}"
    mode: '600'

- name: Copy ssh_key.pub to ambariserver
  copy:
    src: "/tmp/id_rsa_ambari.pub"
    dest: "{{ ambari_key_dest }}.pub"

- name: Set StrictHostKeyChecking no
  copy:
     content: "StrictHostKeyChecking no"
     dest: /root/.ssh/config
     mode: '600'
     force: no
     owner: root

- name: Add ambari repo (on server)
  get_url:
    url: "{{ ambari_repo_url }}"
    dest: /etc/yum.repos.d/ambari.repo

- name: Download and install ambari-server
  yum:
    name: ambari-server

- name: Setup ambari-server
  command: ambari-server setup -s

- name: Download PostgreSQL JDBC driver
  get_url:
    url: https://jdbc.postgresql.org/download/postgresql-42.2.1.jar
    dest: /var/lib/ambari-server

- name: Set PostgreSQL JDBC driver for Ambari
  command: ambari-server setup --jdbc-db=postgres --jdbc-driver=/var/lib/ambari-server/postgresql-42.2.1.jar

- name: Start ambari-server
  service:
    name: ambari-server
    state: started 
