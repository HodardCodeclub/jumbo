---
- name: Post blueprint to ambariserver
  uri:
    url: "http://{{ hostvars[groups['ambariserver'][0]]['ansible_eth1']['ipv4']['address'] }}:8080/api/v1/blueprints/{{ blueprint_name }}"
    headers:
      X-Requested-By: ambari
    method: POST
    force_basic_auth: yes
    user: "{{ ambari_user }}"
    password: "{{ ambari_pwd }}"
    body: " {{ lookup('file', 'blueprint.json') }}"
    body_format: raw
    status_code: 200, 201, 202

- name: Post version_definition to ambariserver
  uri:
    url: "http://{{ hostvars[groups['ambariserver'][0]]['ansible_eth1']['ipv4']['address'] }}:8080/api/v1/version_definitions"
    headers:
      X-Requested-By: ambari
    method: POST
    force_basic_auth: yes
    user: "{{ ambari_user }}"
    password: "{{ ambari_pwd }}"
    body: " {{ lookup('file', 'version_definitions.json')}}"
    body_format: raw
    status_code: 200, 201, 202

- name: Create cluster instance
  uri:
    url: "http://{{ hostvars[groups['ambariserver'][0]]['ansible_eth1']['ipv4']['address'] }}:8080/api/v1/clusters/{{ cluster_name }}"
    headers:
      X-Requested-By: ambari
    method: POST
    force_basic_auth: yes
    user: "{{ ambari_user }}"
    password: "{{ ambari_pwd }}"
    body: " {{ lookup('file', 'cluster.json')}}"
    body_format: raw
    status_code: 200, 201, 202
    return_content: yes
  register: cluster_resp

- name: Waiting for HDP install
  debug:
    msg: "Installation of cluster {{ cluster_name }} in progress. Request id: {{ (cluster_resp.content|from_json).Requests.id }}"